# Changelog

## [1.4.0] - 2025-09-18

### 新增
- **Base Client 架构**：抽象基础类别，统一不同交易所的 API 介面
- **精确仓位管理**：只平掉超出阈值的部分，避免过度平仓风控
- **分层日志系统**：市场状态、策略决策、价格计算、执行结果四层资讯
- **相容性设计**：支援多种 API 回应格式，强化错误处理机制

## [1.3.0] - 2025-09-18

### 新增
- **新增永续合约 (`perp`) 做市功能**：在原有的现货做市基础上，扩展支援永续合约交易，采用**风险中性库存管理**策略。
- **引入目标绝对持仓量 (`target_position`)**：此参数让用户设定期望维持的库存大小（绝对值）。策略以被动成交来建立库存，并在仓位**超过**目标时自动执行减仓，以控制总曝险。
- **实现报价偏移以对冲风险 (`inventory_skew`)**：新增了核心的风险管理机制。此功能会根据当前的**净仓位 (net position)** 动态调整买卖报价：
    - 当持有多头仓位时，会降低整体报价以鼓励卖出。
    - 当持有空头仓位时，会提高整体报价以鼓励买入。
    - 其最终目标是持续将**净仓位**推向零，达成**方向风险中性 (Delta-Neutral)**。
- **新增仓位硬顶风控 (`max_position`)**：设立一个绝对的持仓量上限，一旦触及，策略会立即强制平仓超出部分，确保风险不会无限扩大。
- **专门的策略模块**：添加 `strategies/perp_market_maker.py` 档案，用于处理所有永续合约的专有逻辑。
- **更新用户介面**：在 `run.py` 的命令列参数和 `commands.py` 的互动介面中，加入了完整的永续合约做市设定选项。

## [1.2.0] - 2025-07-04

### 新增
- 支援计算抵押品余额并整合至总资产统计
- 新增重平衡参数设定，可调整目标比例与触发阈值
- CLI 与 run.py 提供重平衡开关与模拟测试介面

### 修复
- 修正科学记号价格步长计算
- 修正重平逻辑与资产比例设定，移除历史交易资料获取
- 修正价格取得与 WebSocket 断线异常

### 优化
- 更新依赖版本并改善日志输出格式


## [1.1.2] - 2025-04-10

### 新增

- 添加 WebSocket 代理连接支持，允许通过代理服务器连接

### 优化

- 自动终止程序功能：当 API 签名创建失败时立即停止运行，防止无效操作


## [1.1.1] - 2025-04-09

### 新增

- 彻底改进重平衡机制风险评估方法，基于总资产价值而非累计交易量
- 添加动态风险暴露度计算，对实际风险提供更精确的评估
- 为重平衡决策添加详细日志，包括净部位价值和风险暴露比例

### 优化

- 完善重平衡系统的错误处理，确保网络或API问题时仍能正常运作
- 为风险判断增加备用机制，在资产数据无法获取时回退至旧方法

### 安全

- 改进风险评估算法，防止在大量交易累积后风险被系统性低估

## [1.1.0] - 2025-04-09

### 新增

- 为 WebSocket 客户端添加专门的日志标识，使日志更易识别
- 在心跳检测失败时添加更详细的日志记录

### 修改

- 将 WebSocket 相关的日志改名为 `backpack_ws`，使日志更具描述性

### 修复

- 彻底重构 WebSocket 断线重连机制，解决连接无法完全重置的问题
- 修复 WebSocket 断线后资源未完全释放的问题
- 改进 `on_close` 处理逻辑，使用独立线程进行重连以避免阻塞回调
- 优化连接关闭逻辑，确保所有相关资源和线程都被正确清理
- 增强 WebSocket 心跳检测机制，更快侦测并恢复中断的连接

## [1.0.0] - 2025-04-08

### 新增

- 实现基础做市策略与 WebSocket 即时数据连接
- 建立命令列介面与互动式面板
- 完成设定档管理及资料库支援
- 实现日志系统并提供完整 README 说明